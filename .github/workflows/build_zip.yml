name: Build ZIP from folder

on:
  workflow_dispatch:
    inputs:
      target_folder:
        description: "Folder to zip (relative to repo root)"
        required: false
        default: "src"
      zip_name:
        description: "Base ZIP name (default: repository name, lowercase)"
        required: false
        default: ""
      version_suffix:
        description: "Optional version suffix for filename (example 01.02.03)"
        required: false
        default: ""

permissions:
  contents: read

jobs:
  zip:
    name: Package folder as ZIP
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify tooling
        shell: bash
        run: |
          set -euo pipefail

          if ! command -v zip >/dev/null 2>&1; then
            echo "ERROR: zip is not installed on runner" >&2
            exit 1
          fi

          if ! command -v sha256sum >/dev/null 2>&1; then
            echo "ERROR: sha256sum is not available on runner" >&2
            exit 1
          fi

          if command -v zipinfo >/dev/null 2>&1; then
            echo "ZIPINFO_AVAILABLE=true" >> "$GITHUB_ENV"
          else
            echo "ZIPINFO_AVAILABLE=false" >> "$GITHUB_ENV"
          fi

          if command -v unzip >/dev/null 2>&1; then
            echo "UNZIP_AVAILABLE=true" >> "$GITHUB_ENV"
          else
            echo "UNZIP_AVAILABLE=false" >> "$GITHUB_ENV"
          fi

      - name: Validate inputs
        shell: bash
        run: |
          set -euo pipefail

          TARGET_FOLDER="${{ github.event.inputs.target_folder }}"
          if [[ -z "$TARGET_FOLDER" ]]; then
            TARGET_FOLDER="src"
          fi

          ZIP_NAME_INPUT="${{ github.event.inputs.zip_name }}"
          ZIP_NAME_INPUT="${ZIP_NAME_INPUT//[[:space:]]/}"

          VERSION_SUFFIX="${{ github.event.inputs.version_suffix }}"
          VERSION_SUFFIX="${VERSION_SUFFIX//[[:space:]]/}"

          if [[ ! -d "$TARGET_FOLDER" ]]; then
            echo "ERROR: Folder does not exist: $TARGET_FOLDER" >&2
            exit 1
          fi

          if [[ -n "$VERSION_SUFFIX" ]] && [[ ! "$VERSION_SUFFIX" =~ ^[0-9]{2}\.[0-9]{2}\.[0-9]{2}$ ]]; then
            echo "ERROR: version_suffix must match NN.NN.NN (example 01.02.03)" >&2
            exit 1
          fi

          if [[ -n "$ZIP_NAME_INPUT" ]]; then
            ZIP_NAME_INPUT="$(echo "$ZIP_NAME_INPUT" | tr '[:upper:]' '[:lower:]')"
          fi

          echo "TARGET_FOLDER=$TARGET_FOLDER" >> "$GITHUB_ENV"
          echo "INPUT_ZIP_NAME=$ZIP_NAME_INPUT" >> "$GITHUB_ENV"
          echo "INPUT_VERSION_SUFFIX=$VERSION_SUFFIX" >> "$GITHUB_ENV"

      - name: Prepare dist folder
        shell: bash
        run: |
          set -euo pipefail
          rm -rf dist
          mkdir -p dist

      - name: Resolve version
        shell: bash
        run: |
          set -euo pipefail

          VERSION_SUFFIX="$INPUT_VERSION_SUFFIX"

          if [[ -z "$VERSION_SUFFIX" ]]; then
            XML_FILE=""
            if [[ -f "$TARGET_FOLDER/templateDetails.xml" ]]; then
              XML_FILE="$TARGET_FOLDER/templateDetails.xml"
            elif [[ -f "$TARGET_FOLDER/manifest.xml" ]]; then
              XML_FILE="$TARGET_FOLDER/manifest.xml"
            fi

            if [[ -n "$XML_FILE" ]]; then
              VERSION_SUFFIX=$(grep -oPm1 '(?<=<version>)[^<]+' "$XML_FILE" || true)
            fi
          fi

          if [[ -n "$VERSION_SUFFIX" ]] && [[ ! "$VERSION_SUFFIX" =~ ^[0-9]{2}\.[0-9]{2}\.[0-9]{2}$ ]]; then
            echo "ERROR: Version found in XML is invalid: $VERSION_SUFFIX" >&2
            exit 1
          fi

          if [[ -z "$VERSION_SUFFIX" ]]; then
            VERSION_SUFFIX="$(echo "${GITHUB_REPOSITORY##*/}" | tr '[:upper:]' '[:lower:]')"
          fi

          echo "VERSION_SUFFIX=$VERSION_SUFFIX" >> "$GITHUB_ENV"

      - name: Create ZIP archive
        shell: bash
        run: |
          set -euo pipefail

          DEFAULT_REPO_NAME="$(echo "${GITHUB_REPOSITORY##*/}" | tr '[:upper:]' '[:lower:]')"
          BASE_ZIP_NAME="$INPUT_ZIP_NAME"

          if [[ -z "$BASE_ZIP_NAME" ]]; then
            BASE_ZIP_NAME="$DEFAULT_REPO_NAME"
          fi

          SAFE_FOLDER_NAME="$(echo "$TARGET_FOLDER" | tr '/' '-')"

          ZIP_NAME="${BASE_ZIP_NAME}-${SAFE_FOLDER_NAME}-${VERSION_SUFFIX}.zip"
          ZIP_PATH="dist/$ZIP_NAME"

          cd "$TARGET_FOLDER"

          zip -r "../$ZIP_PATH" . \
            -x "*.DS_Store" \
            -x "__MACOSX/*" \
            -x ".git/*" \
            -x ".github/*" \
            -x "node_modules/*" \
            -x "coverage/*" \
            -x "*.log" \
            -x "*.tmp"

          echo "ZIP_NAME=$ZIP_NAME" >> "$GITHUB_ENV"
          echo "ZIP_PATH=$ZIP_PATH" >> "$GITHUB_ENV"

          echo "ZIP_NAME=$ZIP_NAME" >> "$GITHUB_ENV"
          echo "ZIP_PATH=$ZIP_PATH" >> "$GITHUB_ENV"

      - name: Generate manifest
        shell: bash
        run: |
          set -euo pipefail

          MANIFEST_PATH="dist/${ZIP_NAME}.manifest.txt"

          if [[ "$ZIPINFO_AVAILABLE" == "true" ]]; then
            zipinfo -1 "$ZIP_PATH" > "$MANIFEST_PATH"
          elif [[ "$UNZIP_AVAILABLE" == "true" ]]; then
            unzip -Z1 "$ZIP_PATH" > "$MANIFEST_PATH"
          else
            echo "ERROR: Neither zipinfo nor unzip is available to generate a manifest" >&2
            exit 1
          fi

          echo "MANIFEST_PATH=$MANIFEST_PATH" >> "$GITHUB_ENV"

      - name: Generate SHA256
        shell: bash
        run: |
          set -euo pipefail

          SHA_PATH="dist/${ZIP_NAME}.sha256"
          sha256sum "$ZIP_PATH" > "$SHA_PATH"

          echo "SHA_PATH=$SHA_PATH" >> "$GITHUB_ENV"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: packaged-folder
          path: |
            ${{ env.ZIP_PATH }}
            ${{ env.MANIFEST_PATH }}
            ${{ env.SHA_PATH }}
