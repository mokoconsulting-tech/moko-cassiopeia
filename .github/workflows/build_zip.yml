name: Build ZIP from folder

on:
  workflow_dispatch:
    inputs:
      target_folder:
        description: "Folder to zip (relative to repo root)"
        required: false
        default: "src"
      zip_name:
        description: "Base ZIP name (default: repository name, lowercase)"
        required: false
        default: ""
      version_suffix:
        description: "Optional version suffix for filename (example 01.02.03)"
        required: false
        default: ""

  workflow_call:
    inputs:
      target_folder:
        description: "Folder to zip (relative to repo root)"
        required: false
        type: string
        default: "src"
      zip_name:
        description: "Base ZIP name (default: repository name, lowercase)"
        required: false
        type: string
        default: ""
      version_suffix:
        description: "Optional version suffix for filename (example 01.02.03)"
        required: false
        type: string
        default: ""
    outputs:
      zip_artifact_name:
        description: "Artifact name for the ZIP"
        value: ${{ jobs.zip.outputs.zip_artifact_name }}
      sha_artifact_name:
        description: "Artifact name for the SHA256 file"
        value: ${{ jobs.zip.outputs.sha_artifact_name }}
      zip_file_name:
        description: "ZIP filename inside the artifact"
        value: ${{ jobs.zip.outputs.zip_file_name }}
      sha_file_name:
        description: "SHA256 filename inside the artifact"
        value: ${{ jobs.zip.outputs.sha_file_name }}

permissions:
  contents: read

jobs:
  zip:
    name: Package folder as ZIP
    runs-on: ubuntu-latest

    outputs:
      zip_artifact_name: ${{ steps.meta.outputs.zip_artifact_name }}
      sha_artifact_name: ${{ steps.meta.outputs.sha_artifact_name }}
      zip_file_name: ${{ steps.meta.outputs.zip_file_name }}
      sha_file_name: ${{ steps.meta.outputs.sha_file_name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify tooling
        shell: bash
        run: |
          set -euo pipefail

          if ! command -v zip >/dev/null 2>&1; then
            echo "ERROR: zip is not installed on runner" >&2
            exit 1
          fi

          if ! command -v sha256sum >/dev/null 2>&1; then
            echo "ERROR: sha256sum is not available on runner" >&2
            exit 1
          fi

      - name: Validate inputs
        shell: bash
        run: |
          set -euo pipefail

          TARGET_FOLDER="${{ inputs.target_folder }}"
          ZIP_NAME_INPUT="${{ inputs.zip_name }}"
          VERSION_SUFFIX="${{ inputs.version_suffix }}"

          if [[ -z "$TARGET_FOLDER" ]]; then
            TARGET_FOLDER="${{ github.event.inputs.target_folder }}"
          fi
          if [[ -z "$ZIP_NAME_INPUT" ]]; then
            ZIP_NAME_INPUT="${{ github.event.inputs.zip_name }}"
          fi
          if [[ -z "$VERSION_SUFFIX" ]]; then
            VERSION_SUFFIX="${{ github.event.inputs.version_suffix }}"
          fi

          TARGET_FOLDER="${TARGET_FOLDER//[[:space:]]/}"
          ZIP_NAME_INPUT="${ZIP_NAME_INPUT//[[:space:]]/}"
          VERSION_SUFFIX="${VERSION_SUFFIX//[[:space:]]/}"

          if [[ -z "$TARGET_FOLDER" ]]; then
            TARGET_FOLDER="src"
          fi

          if [[ ! -d "$TARGET_FOLDER" ]]; then
            echo "ERROR: Folder does not exist: $TARGET_FOLDER" >&2
            exit 1
          fi

          if [[ -n "$VERSION_SUFFIX" ]] && [[ ! "$VERSION_SUFFIX" =~ ^[0-9]{2}\.[0-9]{2}\.[0-9]{2}$ ]]; then
            echo "ERROR: version_suffix must match NN.NN.NN (example 01.02.03)" >&2
            exit 1
          fi

          if [[ -n "$ZIP_NAME_INPUT" ]]; then
            ZIP_NAME_INPUT="$(echo "$ZIP_NAME_INPUT" | tr '[:upper:]' '[:lower:]')"
          fi

          echo "TARGET_FOLDER=$TARGET_FOLDER" >> "$GITHUB_ENV"
          echo "INPUT_ZIP_NAME=$ZIP_NAME_INPUT" >> "$GITHUB_ENV"
          echo "INPUT_VERSION_SUFFIX=$VERSION_SUFFIX" >> "$GITHUB_ENV"

      - name: Prepare dist folder
        shell: bash
        run: |
          set -euo pipefail
          rm -rf dist
          mkdir -p dist

      - name: Resolve version
        shell: bash
        run: |
          set -euo pipefail

          VERSION_SUFFIX="$INPUT_VERSION_SUFFIX"

          if [[ -z "$VERSION_SUFFIX" ]]; then
            XML_FILE=""
            if [[ -f "$TARGET_FOLDER/templateDetails.xml" ]]; then
              XML_FILE="$TARGET_FOLDER/templateDetails.xml"
            elif [[ -f "$TARGET_FOLDER/manifest.xml" ]]; then
              XML_FILE="$TARGET_FOLDER/manifest.xml"
            fi

            if [[ -n "$XML_FILE" ]]; then
              VERSION_SUFFIX=$(grep -oPm1 '(?<=<version>)[^<]+' "$XML_FILE" || true)
              VERSION_SUFFIX="${VERSION_SUFFIX//[[:space:]]/}"
            fi
          fi

          if [[ -n "$VERSION_SUFFIX" ]] && [[ ! "$VERSION_SUFFIX" =~ ^[0-9]{2}\.[0-9]{2}\.[0-9]{2}$ ]]; then
            echo "ERROR: Version found in XML is invalid: $VERSION_SUFFIX" >&2
            exit 1
          fi

          if [[ -z "$VERSION_SUFFIX" ]]; then
            VERSION_SUFFIX="$(echo "${GITHUB_REPOSITORY##*/}" | tr '[:upper:]' '[:lower:]')"
          fi

          echo "VERSION_SUFFIX=$VERSION_SUFFIX" >> "$GITHUB_ENV"

      - name: Create ZIP archive
        shell: bash
        run: |
          set -euo pipefail

          DEFAULT_REPO_NAME="$(echo "${GITHUB_REPOSITORY##*/}" | tr '[:upper:]' '[:lower:]')"
          BASE_ZIP_NAME="$INPUT_ZIP_NAME"

          if [[ -z "$BASE_ZIP_NAME" ]]; then
            BASE_ZIP_NAME="$DEFAULT_REPO_NAME"
          fi

          SAFE_FOLDER_NAME="$(echo "$TARGET_FOLDER" | tr '/' '-')"

          ZIP_NAME="${BASE_ZIP_NAME}-${SAFE_FOLDER_NAME}-${VERSION_SUFFIX}.zip"
          ZIP_PATH="dist/$ZIP_NAME"

          cd "$TARGET_FOLDER"

          zip -r "../$ZIP_PATH" . \
            -x "*.DS_Store" \
            -x "__MACOSX/*" \
            -x "node_modules/*" \
            -x "coverage/*" \
            -x "*.log" \
            -x "*.tmp"

          cd - >/dev/null 2>&1

          SHA_PATH="${ZIP_PATH}.sha256"
          sha256sum "$ZIP_PATH" | awk '{print $1}' > "$SHA_PATH"

          echo "ZIP_NAME=$ZIP_NAME" >> "$GITHUB_ENV"
          echo "ZIP_PATH=$ZIP_PATH" >> "$GITHUB_ENV"
          echo "SHA_PATH=$SHA_PATH" >> "$GITHUB_ENV"

      - name: Export artifact metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          echo "zip_artifact_name=$ZIP_NAME" >> "$GITHUB_OUTPUT"
          echo "sha_artifact_name=${ZIP_NAME}.sha256" >> "$GITHUB_OUTPUT"
          echo "zip_file_name=$ZIP_NAME" >> "$GITHUB_OUTPUT"
          echo "sha_file_name=$(basename "$SHA_PATH")" >> "$GITHUB_OUTPUT"

      - name: Upload ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP_NAME }}
          path: ${{ env.ZIP_PATH }}

      - name: Upload SHA256 artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP_NAME }}.sha256
          path: ${{ env.SHA_PATH }}
