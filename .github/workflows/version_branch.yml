#
# Copyright (C) 2025 Moko Consulting <hello@mokoconsulting.tech>
#
# This file is part of a Moko Consulting project.
#
# SPDX-License-Identifier: GPL-3.0-or-later
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# FILE INFORMATION
# DEFGROUP: MokoStandards.Joomla
# INGROUP: GitHub.Versioning.Branching
# REPO: https://github.com/mokoconsulting-tech/MokoStandards
# PATH: /.github/workflows/version_branch.yml
# VERSION: 01.00.00
# BRIEF: Create a version branch and align versions across governed files
# NOTE: Enterprise gates: policy checks, collision defense, scoped changes, audit summary, error summary

name: Create version branch and bump versions

on:
  workflow_dispatch:
    inputs:
      new_version:
        description: "New version in format NN.NN.NN (example 03.01.00)"
        required: true
      branch_prefix:
        description: "Branch prefix for version branches (example dev/)"
        required: false
        default: "dev/"
      commit_changes:
        description: "Commit and push changes"
        required: false
        default: "true"
        type: choice
        options:
          - "true"
          - "false"
      dry_run:
        description: "Run validations and reports without pushing or committing"
        required: false
        default: "false"
        type: choice
        options:
          - "true"
          - "false"

concurrency:
  group: ${{ github.workflow }}-${{ github.repository }}-${{ github.event.inputs.new_version }}
  cancel-in-progress: false

permissions:
  contents: write

defaults:
  run:
    shell: bash

jobs:
  version-bump:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    env:
      NEW_VERSION: ${{ github.event.inputs.new_version }}
      BASE_BRANCH: ${{ github.ref_name }}
      BRANCH_PREFIX: ${{ github.event.inputs.branch_prefix }}
      COMMIT_CHANGES: ${{ github.event.inputs.commit_changes }}
      DRY_RUN: ${{ github.event.inputs.dry_run }}
      ERROR_LOG: /tmp/version_branch_errors.log
      CI_HELPERS: /tmp/moko_ci_helpers.sh

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref_name }}

      - name: Init CI helpers
        run: |
          set -Eeuo pipefail

          : > "$ERROR_LOG"

          cat > "$CI_HELPERS" <<'SH'
          set -Eeuo pipefail

          moko_init() {
            local step_name="${1:-step}"

            export PS4='+ ['"${step_name}"':${BASH_SOURCE##*/}:${LINENO}] '
            set -x

            trap 'moko_on_err "$step_name" "$LINENO" "$BASH_COMMAND"' ERR
          }

          moko_on_err() {
            local step_name="$1"
            local line_no="$2"
            local last_cmd="$3"

            echo "[FATAL] ${step_name} failed at line ${line_no}" >&2
            echo "[FATAL] Last command: ${last_cmd}" >&2

            if [[ -n "${ERROR_LOG:-}" ]]; then
              echo "$(date -u +%Y-%m-%dT%H:%M:%SZ) | ${step_name} | line ${line_no} | ${last_cmd}" >> "$ERROR_LOG" || true
            fi
          }

          moko_bool() {
            local v="${1:-false}"
            [[ "${v}" == "true" ]]
          }

          moko_notice() {
            echo "[INFO] $*"
          }

          moko_warn() {
            echo "[WARN] $*" >&2
          }
          SH

          chmod 0755 "$CI_HELPERS"

      - name: Validate inputs
        run: |
          source "$CI_HELPERS"
          moko_init "Validate inputs"

          moko_notice "Inputs received:"
          moko_notice "  NEW_VERSION=${NEW_VERSION}"
          moko_notice "  BASE_BRANCH=${BASE_BRANCH}"
          moko_notice "  BRANCH_PREFIX=${BRANCH_PREFIX}"
          moko_notice "  COMMIT_CHANGES=${COMMIT_CHANGES}"
          moko_notice "  DRY_RUN=${DRY_RUN}"

          [[ -n "${NEW_VERSION}" ]] || { echo "[ERROR] new_version missing" >&2; exit 2; }
          [[ "${NEW_VERSION}" =~ ^[0-9]{2}[.][0-9]{2}[.][0-9]{2}$ ]] || { echo "[ERROR] Invalid version format: ${NEW_VERSION}" >&2; exit 2; }

          [[ -n "${BRANCH_PREFIX}" ]] || { echo "[ERROR] branch_prefix missing" >&2; exit 2; }
          [[ "${BRANCH_PREFIX}" =~ ^[A-Za-z0-9._/-]+$ ]] || { echo "[ERROR] Invalid branch_prefix: ${BRANCH_PREFIX}" >&2; exit 2; }
          [[ "${BRANCH_PREFIX}" == */ ]] || { echo "[ERROR] branch_prefix must end with '/'" >&2; exit 2; }

          if moko_bool "${DRY_RUN}"; then
            moko_notice "Dry run enabled. No pushes and no commits will be executed."
          fi

          git ls-remote --exit-code --heads origin "${BASE_BRANCH}" >/dev/null 2>&1 || {
            echo "[ERROR] Base branch does not exist on origin: ${BASE_BRANCH}" >&2
            echo "[INFO] Remote branches:" >&2
            git ls-remote --heads origin | awk '{sub("refs/heads/","",$2); print $2}' >&2
            exit 2
          }

          moko_notice "Input validation passed"

      - name: Enterprise policy gate (required files)
        run: |
          source "$CI_HELPERS"
          moko_init "Enterprise policy gate"

          required=(
            "LICENSE.md"
            "CONTRIBUTING.md"
            "CODE_OF_CONDUCT.md"
            "SECURITY.md"
            "GOVERNANCE.md"
            "CHANGELOG.md"
          )

          missing=0
          for f in "${required[@]}"; do
            if [[ ! -f "${f}" ]]; then
              echo "[ERROR] Missing required file: ${f}" >&2
              missing=1
              continue
            fi
            if [[ ! -s "${f}" ]]; then
              echo "[ERROR] Required file is empty: ${f}" >&2
              missing=1
              continue
            fi
          done

          if [[ "${missing}" -ne 0 ]]; then
            echo "[FATAL] Policy gate failed. Add missing governance artifacts before versioning." >&2
            exit 2
          fi

          if [[ -f ".github/CODEOWNERS" ]] && [[ ! -s ".github/CODEOWNERS" ]]; then
            echo "[ERROR] .github/CODEOWNERS exists but is empty" >&2
            exit 2
          fi

          moko_notice "Policy gate passed"

      - name: Configure git identity
        run: |
          source "$CI_HELPERS"
          moko_init "Configure git identity"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          moko_notice "Git identity configured"

      - name: Branch namespace collision defense
        run: |
          source "$CI_HELPERS"
          moko_init "Branch namespace collision defense"

          PREFIX_TOP="${BRANCH_PREFIX%%/*}"
          if git ls-remote --exit-code --heads origin "${PREFIX_TOP}" >/dev/null 2>&1; then
            echo "[ERROR] Branch namespace collision detected" >&2
            echo "[ERROR] A branch named '${PREFIX_TOP}' exists on origin, so '${BRANCH_PREFIX}<version>' cannot be created." >&2
            echo "[ERROR] Remediation options:" >&2
            echo "  - Change branch_prefix to a non colliding namespace (example release/dev/)" >&2
            echo "  - Rename the existing '${PREFIX_TOP}' branch (organizational policy permitting)" >&2
            exit 2
          fi

          moko_notice "No namespace collision detected for BRANCH_PREFIX=${BRANCH_PREFIX}"

      - name: Create version branch
        run: |
          source "$CI_HELPERS"
          moko_init "Create version branch"

          BRANCH_NAME="${BRANCH_PREFIX}${NEW_VERSION}"
          echo "BRANCH_NAME=${BRANCH_NAME}" >> "$GITHUB_ENV"

          moko_notice "Creating branch: ${BRANCH_NAME} from origin/${BASE_BRANCH}"

          git fetch --all --tags --prune

          if git ls-remote --exit-code --heads origin "${BRANCH_NAME}" >/dev/null 2>&1; then
            echo "[ERROR] Branch already exists on origin: ${BRANCH_NAME}" >&2
            exit 2
          fi

          git checkout -B "${BRANCH_NAME}" "origin/${BASE_BRANCH}"

      - name: Push version branch
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          source "$CI_HELPERS"
          moko_init "Push version branch"

          moko_notice "Pushing new branch to origin: ${BRANCH_NAME}"
          git push --set-upstream origin "${BRANCH_NAME}"

      - name: Ensure CHANGELOG.md rolls UNRELEASED into the release (no TODO)
        run: |
          source "$CI_HELPERS"
          moko_init "CHANGELOG governance"

          python3 - <<'PY'
          import os
          import re
          from datetime import datetime, timezone
          from pathlib import Path

          nl = chr(10)
          cr = chr(13)

          new_version = (os.environ.get('NEW_VERSION') or '').strip() or '00.00.00'

          p = Path('CHANGELOG.md')
          if not p.exists():
            raise SystemExit('[FATAL] CHANGELOG.md missing')

          lines = p.read_text(encoding='utf-8', errors='replace').splitlines(True)

          h1_re = re.compile(r'^#\s+Changelog\b.*$', re.IGNORECASE)
          bullet_re = re.compile(r'^[ ]*[-*+][ ]+')
          blank_re = re.compile(r'^[ ]*$')
          unreleased_re = re.compile(r'^[ ]*##[ ]*(?:\[[ ]*UNRELEASED[ ]*\]|UNRELEASED)[ ]*$', re.IGNORECASE)

          stamp = datetime.now(timezone.utc).strftime('%Y-%m-%d')
          version_h2 = '## [' + new_version + '] ' + stamp + nl
          version_prefix = '## [' + new_version + '] '

          if any(l.strip().startswith(version_prefix) for l in lines):
            print('[INFO] Version H2 already present. No action taken.')
            raise SystemExit(0)

          h1_idx = None
          for i, line in enumerate(lines):
            if h1_re.match(line.strip()):
              h1_idx = i
              break

          if h1_idx is None:
            print('[ERROR] CHANGELOG.md missing required H1 beginning with: # Changelog')
            raise SystemExit(2)

          insert_at = h1_idx + 1
          while insert_at < len(lines) and blank_re.match(lines[insert_at].rstrip(nl).rstrip(cr)):
            insert_at += 1

          unreleased_idx = None
          for i, line in enumerate(lines):
            if unreleased_re.match(line.strip()):
              unreleased_idx = i
              break

          if unreleased_idx is not None:
            lines[unreleased_idx] = version_h2

            k = unreleased_idx + 1
            moved = []
            while k < len(lines):
              if lines[k].lstrip().startswith('## '):
                break
              moved.append(lines[k])
              k += 1

            if not any(bullet_re.match(x.rstrip(nl).rstrip(cr)) for x in moved):
              moved = ['- Version bump' + nl]

            lines[unreleased_idx + 1:k] = moved

            insert_unreleased = nl + '## [UNRELEASED]' + nl + '- ' + nl + nl
            lines.insert(insert_at, insert_unreleased)

          else:
            insert = (
              nl +
              '## [' + new_version + '] ' + stamp + nl +
              '- Version bump' + nl
            )
            lines.insert(insert_at, insert)

          text = ''.join(lines)

          text = re.sub(
            r'(?im)^(\s*VERSION\s*:\s*)\d{2}\.\d{2}\.\d{2}(\s*)$',
            r'' + new_version + r'',
            text,
            count=1,
          )

          text = re.sub(
            r'(?im)^(#\s+Changelog\b.*\(VERSION:\s*)(\d{2}\.\d{2}\.\d{2})(\)\s*)$',
            r'' + new_version + r'',
            text,
            count=1,
          )

          p.write_text(text, encoding='utf-8')
          PY

      - name: Preflight discovery (governed version markers outside .github)
        run: |
          source "$CI_HELPERS"
          moko_init "Preflight discovery"

          moko_notice "Scanning all directories except .github"

          COUNT=$(grep -RIn --exclude-dir=.git --exclude-dir=.github -i -E "VERSION[[:space:]]*:[[:space:]]*[0-9]{2}[.][0-9]{2}[.][0-9]{2}" . | wc -l || true)
          moko_notice "VERSION: hits (repo wide): ${COUNT}"

          COUNT2=$(grep -RIn --exclude-dir=.git --exclude-dir=.github "<version" . | wc -l || true)
          moko_notice "<version> hits (repo wide): ${COUNT2}"

          if [[ "${COUNT}" -eq 0 && "${COUNT2}" -eq 0 ]]; then
