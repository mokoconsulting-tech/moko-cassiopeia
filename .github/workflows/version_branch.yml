name: Create version branch and bump versions

on:
  workflow_dispatch:
    inputs:
      new_version:
        description: "New version in format NN.NN.NN (example 01.03.00)"
        required: true
      base_branch:
        description: "Base branch to branch from"
        required: false
        default: "main"
      branch_prefix:
        description: "Prefix for the new version branch"
        required: false
        default: "version/"
      commit_changes:
        description: "Commit and push changes"
        required: false
        default: "true"
        type: choice
        options:
          - "true"
          - "false"

permissions:
  contents: write

jobs:
  version-bump:
    runs-on: ubuntu-latest

    env:
      NEW_VERSION: ${{ github.event.inputs.new_version }}
      BASE_BRANCH: ${{ github.event.inputs.base_branch }}
      BRANCH_PREFIX: ${{ github.event.inputs.branch_prefix }}
      COMMIT_CHANGES: ${{ github.event.inputs.commit_changes }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ env.BASE_BRANCH }}

      - name: Validate inputs
        shell: bash
        run: |
          set -Eeuo pipefail
          trap 'echo "[FATAL] Validation error at line $LINENO" >&2' ERR

          echo "[INFO] Inputs received:"
          echo "  NEW_VERSION=${NEW_VERSION}"
          echo "  BASE_BRANCH=${BASE_BRANCH}"
          echo "  BRANCH_PREFIX=${BRANCH_PREFIX}"

          [[ -n "${NEW_VERSION}" ]] || { echo "[ERROR] new_version missing"; exit 2; }
          [[ "${NEW_VERSION}" =~ ^[0-9]{2}\.[0-9]{2}\.[0-9]{2}$ ]] || {
            echo "[ERROR] Invalid version format: ${NEW_VERSION}"
            exit 2
          }

          git show-ref --verify --quiet "refs/remotes/origin/${BASE_BRANCH}" || {
            echo "[ERROR] Base branch does not exist on origin: ${BASE_BRANCH}"
            git branch -a
            exit 2
          }

          echo "[INFO] Input validation passed"

      - name: Configure git identity
        shell: bash
        run: |
          set -Eeuo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          echo "[INFO] Git identity configured"

      - name: Create version branch
        shell: bash
        run: |
          set -Eeuo pipefail
          trap 'echo "[FATAL] Branch creation failed at line $LINENO" >&2' ERR

          BRANCH_NAME="${BRANCH_PREFIX}${NEW_VERSION}"
          echo "[INFO] Creating branch ${BRANCH_NAME}"

          git fetch --all --tags --prune

          if git ls-remote --exit-code --heads origin "${BRANCH_NAME}" >/dev/null 2>&1; then
            echo "[ERROR] Branch already exists on origin: ${BRANCH_NAME}"
            exit 2
          fi

          git checkout -B "${BRANCH_NAME}" "origin/${BASE_BRANCH}"

      - name: Bump versions in headers and XML
        shell: bash
        run: |
          set -Eeuo pipefail
          trap 'echo "[FATAL] Version bump failed at line $LINENO" >&2' ERR

          python3 - <<'PY'
          import re
          from pathlib import Path
          import os

          new_version = os.environ["NEW_VERSION"]
          root = Path(".").resolve()

          header_re = re.compile(r"(?m)^(\\s*VERSION\\s*:\\s*)(\\d{2}\\.\\d{2}\\.\\d{2})(\\s*)$")
          xml_re = re.compile(r"(?is)(<version\\s*>)(\\s*\\d{2}\\.\\d{2}\\.\\d{2}\\s*)(</version\\s*>)")

          updated = []

          for p in root.rglob("*"):
            if not p.is_file():
              continue
            if p.suffix.lower() == ".json":
              continue
            try:
              text = p.read_text(encoding="utf-8")
            except Exception:
              continue

            original = text
            text = header_re.sub(r"\\1" + new_version + r"\\3", text)
            if p.suffix.lower() == ".xml":
              text = xml_re.sub(r"\\1" + new_version + r"\\3", text)

            if text != original:
              p.write_text(text, encoding="utf-8")
              updated.append(str(p))

          if not updated:
            raise SystemExit("[ERROR] No files updated. Check headers and XML manifests.")

          print(f"[INFO] Updated {len(updated)} files")
          for f in updated:
            print(f"  - {f}")
          PY

      - name: Commit changes
        if: ${{ env.COMMIT_CHANGES == 'true' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          git status --porcelain
          git add -A
          git commit -m "chore(release): bump version to ${NEW_VERSION}"

      - name: Push branch
        if: ${{ env.COMMIT_CHANGES == 'true' }}
        shell: bash
        run: |
          set -Eeuo pipefail
          git push --set-upstream origin "${BRANCH_PREFIX}${NEW_VERSION}"
