# ============================================================================
# Copyright (C) 2025 Moko Consulting <hello@mokoconsulting.tech>
#
# This file is part of a Moko Consulting project.
#
# SPDX-License-Identifier: GPL-3.0-or-later
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <https://www.gnu.org/licenses/>.
#
# FILE INFORMATION
# DEFGROUP: GitHub.Workflow
# INGROUP: MokoStandards.Validation
# REPO: https://github.com/mokoconsulting-tech/MokoStandards
# PATH: /.github/workflows/config_guardrails.yml
# VERSION: 03.05.00
# BRIEF: Validate that required repository secrets and variables exist for workflows and scripts.
# NOTE: Secrets are never printed. This workflow only verifies presence and emits an audit JSON report.
# ============================================================================

name: Guardrails

on:
  workflow_dispatch:
    inputs:
      profile:
        description: "Which configuration profile to validate. release checks SFTP variables used by release_pipeline. scripts checks baseline script prerequisites. all runs both."
        required: true
        default: all
        type: choice
        options:
          - all
          - release
          - scripts
  pull_request:
    paths:
      - ".github/workflows/**"
      - "scripts/**"

permissions:
  contents: read

jobs:
  release_config:
    name: Release configuration
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Guardrails: release secrets and vars
        env:
          PROFILE: ${{ github.event.inputs.profile || 'all' }}
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_KEY: ${{ secrets.FTP_KEY }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          FTP_PATH: ${{ secrets.FTP_PATH }}
          FTP_PROTOCOL: ${{ secrets.FTP_PROTOCOL }}
          FTP_PORT: ${{ secrets.FTP_PORT }}
          FTP_PATH_SUFFIX: ${{ vars.FTP_PATH_SUFFIX }}
        run: |
          set -euxo pipefail

          profile="${PROFILE}"
          if [ "${profile}" != "all" ] && [ "${profile}" != "release" ] && [ "${profile}" != "scripts" ]; then
            echo "ERROR: Unknown profile: ${profile}" >> "${GITHUB_STEP_SUMMARY}"
            exit 1
          fi

          if [ "${profile}" = "scripts" ]; then
            echo "Profile scripts selected. Skipping release configuration checks." >> "${GITHUB_STEP_SUMMARY}"
            exit 0
          fi

          required=(
            "FTP_HOST"
            "FTP_USER"
            "FTP_KEY"
            "FTP_PATH"
          )

          optional=(
            "FTP_PASSWORD"
            "FTP_PROTOCOL"
            "FTP_PORT"
            "FTP_PATH_SUFFIX"
          )

          missing=()
          missing_optional=()

          for k in "${required[@]}"; do
            v="${!k:-}"
            if [ -z "${v}" ]; then
              missing+=("${k}")
            fi
          done

          for k in "${optional[@]}"; do
            v="${!k:-}"
            if [ -z "${v}" ]; then
              missing_optional+=("${k}")
            fi
          done

          proto="${FTP_PROTOCOL:-sftp}"
          if [ -n "${FTP_PROTOCOL:-}" ] && [ "${proto}" != "sftp" ]; then
            missing+=("FTP_PROTOCOL_INVALID")
          fi

          # Key format guardrail (do not print key material).
          if [ -n "${FTP_KEY:-}" ]; then
            first_line="$(printf '%s' "${FTP_KEY}" | head -n 1 || true)"
            if printf '%s' "${first_line}" | grep -q '^PuTTY-User-Key-File-'; then
              key_format="ppk"
            elif printf '%s' "${first_line}" | grep -q '^-----BEGIN '; then
              key_format="openssh"
            else
              key_format="unknown"
              missing+=("FTP_KEY_FORMAT")
            fi
          else
            key_format="missing"
          fi

          {
            echo "### Guardrails: release configuration"
            echo "KEY_FORMAT=${key_format}"
            echo ""
            echo "### Guardrails report (JSON)"
            echo "```json"
            printf '{"profile":"%s","checked":{"required":[' "${profile}"
            sep=""
            for c in "${required[@]}"; do
              printf '%s"%s"' "${sep}" "${c}"
              sep=",";
            done
            printf '],"optional":['
            sep=""
            for c in "${optional[@]}"; do
              printf '%s"%s"' "${sep}" "${c}"
              sep=",";
            done
            printf ']},"missing_required":['
            sep=""
            for m in "${missing[@]}"; do
              printf '%s"%s"' "${sep}" "${m}"
              sep=",";
            done
            printf '],"missing_optional":['
            sep=""
            for m in "${missing_optional[@]}"; do
              printf '%s"%s"' "${sep}" "${m}"
              sep=",";
            done
            printf ']}
'
            echo "```"
          } >> "${GITHUB_STEP_SUMMARY}"

          if [ "${#missing[@]}" -gt 0 ]; then
            echo "### Missing required release configuration" >> "${GITHUB_STEP_SUMMARY}"
            for m in "${missing[@]}"; do
              echo "- ${m}" >> "${GITHUB_STEP_SUMMARY}"
            done
          fi

          if [ "${#missing_optional[@]}" -gt 0 ]; then
            echo "### Missing optional release configuration" >> "${GITHUB_STEP_SUMMARY}"
            for m in "${missing_optional[@]}"; do
              echo "- ${m}" >> "${GITHUB_STEP_SUMMARY}"
            done
          fi

          if [ "${#missing[@]}" -gt 0 ]; then
            echo "MISSING_REQUIRED: ${missing[*]}" >&2
            echo "ERROR: Guardrails failed. Missing required release configuration." >> "${GITHUB_STEP_SUMMARY}"
            exit 1
          fi

  scripts_config:
    name: Scripts and tooling
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Guardrails: script files and toolchain
        env:
          PROFILE: ${{ github.event.inputs.profile || 'all' }}
        run: |
          set -euxo pipefail

          profile="${PROFILE}"
          if [ "${profile}" != "all" ] && [ "${profile}" != "release" ] && [ "${profile}" != "scripts" ]; then
            echo "ERROR: Unknown profile: ${profile}" >> "${GITHUB_STEP_SUMMARY}"
            exit 1
          fi

          if [ "${profile}" = "release" ]; then
            echo "Profile release selected. Skipping scripts checks." >> "${GITHUB_STEP_SUMMARY}"
            exit 0
          fi

          required_script_files=(
            "scripts/validate/manifest.sh"
            "scripts/validate/xml_wellformed.sh"
            "scripts/validate/changelog.sh"
            "scripts/validate/tabs.sh"
            "scripts/validate/paths.sh"
            "scripts/validate/version_alignment.sh"
            "scripts/validate/language_structure.sh"
            "scripts/validate/php_syntax.sh"
            "scripts/validate/no_secrets.sh"
            "scripts/validate/license_headers.sh"
          )

          legacy_script_files=(
            "scripts/validate_manifest.sh"
            "scripts/validate_xml_wellformed.sh"
            "scripts/validate_changelog.sh"
            "scripts/validate_tabs.sh"
            "scripts/validate_paths.sh"
            "scripts/validate_version_alignment.sh"
            "scripts/validate_language_structure.sh"
            "scripts/validate_php_syntax.sh"
            "scripts/validate_no_secrets.sh"
            "scripts/validate_license_headers.sh"
          )

                      fi
          done

          # Report legacy scripts if present so teams can clean up.
          for f in "${legacy_script_files[@]}"; do
            if [ -f "${f}" ]; then
              legacy_present+=("${f}")
            fi
          done

          tools_to_install=()
          command -v php >/dev/null 2>&1 || tools_to_install+=("php-cli")
          command -v xmllint >/dev/null 2>&1 || tools_to_install+=("libxml2-utils")

          if [ "${#tools_to_install[@]}" -gt 0 ]; then
            echo "Installing missing tools: ${tools_to_install[*]}" >> "${GITHUB_STEP_SUMMARY}"
            sudo apt-get update -y
          ntf '%s"%s"' "${sep}" "${c}"
              sep=",";
            done
            printf ']},"missing_script_files":['
            sep=""
            for m in "${missing_files[@]}"; do
              printf '%s"%s"' "${sep}" "${m}"
              sep=",";
            done
            printf '],"legacy_present":['
            sep=""
            for m in "${legacy_present[@]}"; do
              printf '%s"%s"' "${sep}" "${m}"
              sep=",";
            done
            printf ']}'
            echo
            echo "```"
          } >> "${GITHUB_STEP_SUMMARY}"

          if [ "${#missing_files[@]}" -gt 0 ]; then
            echo "### Missing script files" >> "${GITHUB_STEP_SUMMARY}"
            for m in "${missing_files[@]}"; do
              echo "- ${m}" >> "${GITHUB_STEP_SUMMARY}"
            done
            echo "MISSING_SCRIPT_FILES: ${missing_files[*]}" >&2
            echo "ERROR: Guardrails failed. Missing required script files." >> "${GITHUB_STEP_SUMMARY}"
            exit 1
          fi
