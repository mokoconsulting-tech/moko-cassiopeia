name: Init UpdateServer Environment

on:
  workflow_dispatch:
    inputs:
      environment_name:
        description: "GitHub Environment name to create or update"
        required: true
        default: "UpdateServer"
      update_xml_repo:
        description: "Repo that hosts updates.xml (owner/repo). Defaults to current repo."
        required: false
        default: ""
      update_xml_branch:
        description: "Branch that contains updates.xml"
        required: true
        default: "main"
      update_xml_path:
        description: "Path to updates.xml in that repo"
        required: true
        default: "updates.xml"

permissions:
  contents: read

jobs:
  init:
    runs-on: ubuntu-latest
    steps:
      - name: Validate admin token is present
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${{ secrets.MOKO_ADMIN_TOKEN }}" ]; then
            echo "ERROR: Missing secret MOKO_ADMIN_TOKEN."
            exit 1
          fi

      - name: Create environment and set variables
        env:
          GH_TOKEN: ${{ secrets.MOKO_ADMIN_TOKEN }}
          ENV_NAME: ${{ github.event.inputs.environment_name }}
          UPDATE_XML_REPO_INPUT: ${{ github.event.inputs.update_xml_repo }}
          UPDATE_XML_BRANCH: ${{ github.event.inputs.update_xml_branch }}
          UPDATE_XML_PATH: ${{ github.event.inputs.update_xml_path }}
          API_URL: ${{ github.api_url }}
          SERVER_URL: ${{ github.server_url }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
        shell: bash
        run: |
          set -euo pipefail

          if [ -n "${UPDATE_XML_REPO_INPUT}" ]; then
            UPDATE_XML_REPO="${UPDATE_XML_REPO_INPUT}"
          else
            UPDATE_XML_REPO="${OWNER}/${REPO}"
          fi

          UPDATESERVER_FILE_URL="${SERVER_URL}/${UPDATE_XML_REPO}/blob/${UPDATE_XML_BRANCH}/${UPDATE_XML_PATH}"

          echo "Target environment: ${ENV_NAME}"
          echo "Variable UPDATESERVER_FILE_URL: ${UPDATESERVER_FILE_URL}"

          echo "Creating or updating environment..."
          curl -sS -f -X PUT \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "${API_URL}/repos/${OWNER}/${REPO}/environments/${ENV_NAME}" \
            -d '{}' \
            -o /tmp/env_response.json

          echo "Environment API response:"
          cat /tmp/env_response.json || true
          echo ""

          echo "Creating or updating environment variable..."
          curl -sS -f -X PUT \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "${API_URL}/repos/${OWNER}/${REPO}/environments/${ENV_NAME}/variables/UPDATESERVER_FILE_URL" \
            -d "{\"name\":\"UPDATESERVER_FILE_URL\",\"value\":\"${UPDATESERVER_FILE_URL}\"}" \
            -o /tmp/var_response.json

          echo "Variable API response:"
          cat /tmp/var_response.json || true
          echo ""

          echo "Applied: ${ENV_NAME}.UPDATESERVER_FILE_URL"
