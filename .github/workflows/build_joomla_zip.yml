# ============================================================================
# Copyright (C) 2025 Moko Consulting <hello@mokoconsulting.tech>
#
# This file is part of a Moko Consulting project.
#
# SPDX-License-Identifier: GPL-3.0-or-later
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <https://www.gnu.org/licenses/>.
#
# FILE INFORMATION
# DEFGROUP: MokoStandards
# INGROUP: GitHub.Workflows
# REPO: https://github.com/mokoconsulting-tech/MokoDefaults
# PATH: /.github/workflows/build_joomla_zip.yml
# VERSION: 01.00.00
# BRIEF: Build a Joomla ZIP from /src and optionally attach it to a GitHub Release.
# Script details
# - Builds a ZIP artifact from the repository /src folder.
# - Runs automatically when a GitHub Release is created.
# - Can be executed manually from the Actions menu (workflow_dispatch).
# - Optionally uploads the ZIP as a Release asset.
# - Provides CI artifacts when not attaching to a Release.

name: Build Joomla ZIP from src

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      attach_to_release:
        description: "Attach the generated ZIP to a GitHub Release"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"
      release_tag:
        description: "Release tag to upload to. If blank, defaults to dev/<version> using templateDetails.xml (example dev/03.02.00)"
        required: false
        default: ""
      zip_name:
        description: "ZIP base name without extension (defaults to repository name)"
        required: false
        default: ""
      zip_suffix:
        description: "Optional suffix appended after version (example rc1, beta, build.5)"
        required: false
        default: ""
      prerelease:
        description: "Mark the uploaded asset as prerelease when attaching to a Release"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

permissions:
  contents: write

jobs:
  build-zip:
    name: Build ZIP
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate src folder exists
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -d "src" ]; then
            echo "ERROR: Required folder 'src' not found at repository root." >&2
            echo "Expected: ./src" >&2
            exit 1
          fi

      - name: Resolve build parameters
        id: params
        shell: bash
        run: |
          set -euo pipefail

          REPO_NAME="${GITHUB_REPOSITORY#*/}"

          ZIP_BASE_INPUT="${{ github.event.inputs.zip_name }}"
          if [ -n "${ZIP_BASE_INPUT}" ]; then
            ZIP_BASE="${ZIP_BASE_INPUT}"
          else
            ZIP_BASE="${REPO_NAME}"

          VERSION=""
          SUFFIX_INPUT="${{ github.event.inputs.zip_suffix }}"

          ATTACH_INPUT="${{ github.event.inputs.attach_to_release }}"

          if [ "${GITHUB_EVENT_NAME}" = "release" ]; then
            ATTACH="true"
            TAG_NAME="${{ github.event.release.tag_name }}"
            VERSION="${TAG_NAME##*/}"
          else
            if [ "${ATTACH_INPUT}" = "true" ]; then
              ATTACH="true"
            else
              ATTACH="false"
            fi

            TAG_INPUT="${{ github.event.inputs.release_tag }}"
            if [ -n "${TAG_INPUT}" ]; then
              TAG_NAME="${TAG_INPUT}"
              VERSION="${TAG_NAME##*/}"
            else
              if [ ! -f "src/templateDetails.xml" ]; then
                echo "ERROR: src/templateDetails.xml not found and release_tag not provided." >&2
                exit 1
              fi

              VERSION=$(grep -Eo '<version>[0-9]+(\.[0-9]+)*</version>' src/templateDetails.xml | head -n1 | sed -E 's#</?version>##g')
              if [ -z "${VERSION}" ]; then
                echo "ERROR: Unable to extract <version> from src/templateDetails.xml." >&2
                exit 1
              fi

              TAG_NAME="dev/${VERSION}"
            fi
          fi

          if [ -n "${SUFFIX_INPUT}" ]; then
            ZIP_NAME="${ZIP_BASE}-${VERSION}-${SUFFIX_INPUT}.zip"
          else
            ZIP_NAME="${ZIP_BASE}-${VERSION}.zip"
          fi
