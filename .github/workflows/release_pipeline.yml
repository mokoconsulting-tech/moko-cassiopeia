# ============================================================================
# Copyright (C) 2025 Moko Consulting <hello@mokoconsulting.tech>
#
# This file is part of a Moko Consulting project.
#
# SPDX-License-Identifier: GPL-3.0-or-later
#
# FILE INFORMATION
# DEFGROUP: GitHub.Workflow
# INGROUP: MokoStandards.Validation
# REPO: https://github.com/mokoconsulting-tech/MokoStandards
# PATH: /.github/workflows/repo_health.yml
# VERSION: 03.05.00
# BRIEF: Enforces Joomla repository guardrails by validating release configuration, scripts governance, and core repository health.
# ============================================================================

name: Repo Health

concurrency:
  group: repo-health-${{ github.repository }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

on:
  workflow_dispatch:
    inputs:
      profile:
        description: Which configuration profile to validate
        required: true
        default: all
        type: choice
        options: [all, release, scripts, repo]
  pull_request:
    paths:
      - .github/workflows/**
      - scripts/**
      - docs/**
      - dev/**

permissions:
  contents: read

jobs:
  access_check:
    name: Access control
    runs-on: ubuntu-latest
    outputs:
      allowed: ${{ steps.perm.outputs.allowed }}
    steps:
      - name: Check actor permission admin only
        id: perm
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const username = context.actor;

            const res = await github.rest.repos.getCollaboratorPermissionLevel({ owner, repo, username });
            const permission = (res?.data?.permission || "unknown").toLowerCase();
            const allowed = permission === "admin";

            core.setOutput("allowed", allowed ? "true" : "false");

            const lines = [
              "### Access control",
              "",
              `Actor: ${username}`,
              `Permission: ${permission}`,
              `Allowed: ${allowed}`,
              "",
              "Policy: Workflow requires admin permission"
            ];

            await core.summary.addRaw(lines.join("\n")).write();

      - name: Deny execution when not permitted
        if: ${{ steps.perm.outputs.allowed != 'true' }}
        run: |
          echo "ERROR: Access denied. Admin permission required." >> "$GITHUB_STEP_SUMMARY"
          exit 1

  release_config:
    name: Release configuration
    runs-on: ubuntu-latest
    needs: [access_check]
    if: ${{ needs.access_check.outputs.allowed == 'true' }}
    steps:
      - uses: actions/checkout@v4

      - name: Guardrails release configuration
        env:
          PROFILE_RAW: ${{ github.event.inputs.profile }}
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_KEY: ${{ secrets.FTP_KEY }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          FTP_PROTOCOL: ${{ secrets.FTP_PROTOCOL }}
          FTP_PORT: ${{ secrets.FTP_PORT }}
        run: |
          set -euo pipefail

          profile="${PROFILE_RAW:-all}"
          if [[ "$profile" == "scripts" || "$profile" == "repo" ]]; then
            echo "Skipping release checks" >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          required=(FTP_HOST FTP_USER FTP_KEY)
          missing=()
          for k in "${required[@]}"; do
            [[ -z "${!k:-}" ]] && missing+=("$k")
          done

          if [[ "${#missing[@]}" -gt 0 ]]; then
            echo "### Missing required release configuration" >> "$GITHUB_STEP_SUMMARY"
            for m in "${missing[@]}"; do echo "- $m" >> "$GITHUB_STEP_SUMMARY"; done
            exit 1
          fi

          echoF
          echo "Release configuration validated" >> "$GITHUB_STEP_SUMMARY"

  scripts_config:
    name: Scripts and tooling
    runs-on: ubuntu-latest
    needs: [access_check]
    if: ${{ needs.access_check.outputs.allowed == 'true' }}
    steps:
      - uses: actions/checkout@v4

      - name: Validate scripts governance
        env:
          PROFILE_RAW: ${{ github.event.inputs.profile }}
        run: |
          set -euo pipefail

          profile="${PROFILE_RAW:-all}"
          [[ "$profile" == "release" || "$profile" == "repo" ]] && exit 0

          required_dirs=(scripts/fix scripts/lib scripts/release scripts/run scripts/validate)
          missing_dirs=()

          for d in "${required_dirs[@]}"; do
            [[ ! -d "$d" ]] && missing_dirs+=("$d/")
          done

          if [[ "${#missing_dirs[@]}" -gt 0 ]]; then
            echo "### Missing script directories" >> "$GITHUB_STEP_SUMMARY"
            for d in "${missing_dirs[@]}"; do echo "- $d" >> "$GITHUB_STEP_SUMMARY"; done
            exit 1
          fi

          echo "Scripts governance validated" >> "$GITHUB_STEP_SUMMARY"

  repo_health:
    name: Repository health
    runs-on: ubuntu-latest
    needs: [access_check]
    if: ${{ needs.access_check.outputs.allowed == 'true' }}
    steps:
      - uses: actions/checkout@v4

      - name: Repository health checks
        env:
          PROFILE_RAW: ${{ github.event.inputs.profile }}
        run: |
          set -euo pipefail

          profile="${PROFILE_RAW:-all}"
          [[ "$profile" == "release" || "$profile" == "scripts" ]] && exit 0

          required_files=(README.md LICENSE CHANGELOG.md CONTRIBUTING.md CODE_OF_CONDUCT.md TODO.md docs/docs-index.md)
          missing=()

          for f in "${required_files[@]}"; do
            [[ ! -f "$f" ]] && missing+=("$f")
          done

          if [[ "${#missing[@]}" -gt 0 ]]; then
            echo "### Missing required repository artifacts" >> "$GITHUB_STEP_SUMMARY"
            for f in "${missing[@]}"; do echo "- $f" >> "$GITHUB_STEP_SUMMARY"; done
            exit 1
          fi

          echo "Repository health validated" >> "$GITHUB_STEP_SUMMARY"
