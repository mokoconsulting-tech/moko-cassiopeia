# Copyright (C) 2026 Moko Consulting <hello@mokoconsulting.tech>
#
# This file is part of a Moko Consulting project.
#
# SPDX-License-Identifier: GPL-3.0-or-later
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <https://www.gnu.org/licenses/>.
#
# FILE INFORMATION
# DEFGROUP: GitHub.Workflow
# INGROUP: MokoStandards.Reusable
# REPO: https://github.com/mokoconsulting-tech/MokoStandards
# PATH: /.github/workflows/reusable-deploy.yml
# VERSION: 01.00.00
# BRIEF: Reusable type-aware deployment workflow for staging and production
# NOTE: Supports Joomla, Dolibarr, and generic deployments with health checks

name: Reusable Deploy

on:
  workflow_call:
    inputs:
      environment:
        description: 'Target environment (staging, production)'
        required: true
        type: string
      version:
        description: 'Version to deploy (optional, uses latest if not specified)'
        required: false
        type: string
      deployment-method:
        description: 'Deployment method (rsync, ftp, ssh, kubernetes, custom)'
        required: false
        type: string
        default: 'custom'
      health-check-url:
        description: 'URL to check after deployment'
        required: false
        type: string
      health-check-timeout:
        description: 'Health check timeout in seconds'
        required: false
        type: number
        default: 300
      working-directory:
        description: 'Working directory'
        required: false
        type: string
        default: '.'
    secrets:
      DEPLOY_HOST:
        description: 'Deployment host/server'
        required: false
      DEPLOY_USER:
        description: 'Deployment user'
        required: false
      DEPLOY_KEY:
        description: 'SSH private key or deployment credentials'
        required: false
      DEPLOY_PATH:
        description: 'Deployment path on target server'
        required: false

permissions:
  contents: read
  deployments: write

jobs:
  detect:
    name: Detect Project Type
    uses: ./.github/workflows/reusable-project-detector.yml
    with:
      working-directory: ${{ inputs.working-directory }}

  prepare:
    name: Prepare Deployment
    runs-on: ubuntu-latest
    needs: detect
    outputs:
      deployment-id: ${{ steps.create-deployment.outputs.deployment_id }}
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          else
            # Use latest tag or commit SHA
            VERSION=$(git describe --tags --always)
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Deploying version: ${VERSION}"

      - name: Create deployment
        id: create-deployment
        uses: chrnorm/deployment-action@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment: ${{ inputs.environment }}
          description: "Deploy ${{ needs.detect.outputs.project-type }} v${{ steps.version.outputs.version }}"

      - name: Deployment info
        run: |
          echo "### ðŸš€ Deployment Preparation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Project Type:** ${{ needs.detect.outputs.project-type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Method:** ${{ inputs.deployment-method }}" >> $GITHUB_STEP_SUMMARY

  build:
    name: Build for Deployment
    needs: [detect, prepare]
    uses: ./.github/workflows/reusable-build.yml
    with:
      working-directory: ${{ inputs.working-directory }}
      upload-artifacts: true
      artifact-name: deployment-package

  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    needs: [detect, prepare, build]
    environment:
      name: ${{ inputs.environment }}
      url: ${{ inputs.health-check-url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download build artifacts
        uses: actions/download-artifact@v7
        with:
          name: deployment-package-${{ needs.detect.outputs.project-type }}
          path: ./dist

      - name: Setup SSH key
        if: inputs.deployment-method == 'ssh' || inputs.deployment-method == 'rsync'
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "${{ secrets.DEPLOY_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy via rsync
        if: inputs.deployment-method == 'rsync'
        run: |
          echo "Deploying via rsync to ${{ secrets.DEPLOY_HOST }}..."

          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            ./dist/ \
            "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_PATH }}"

          echo "âœ… rsync deployment completed" >> $GITHUB_STEP_SUMMARY

      - name: Deploy via SSH
        if: inputs.deployment-method == 'ssh'
        run: |
          echo "Deploying via SSH to ${{ secrets.DEPLOY_HOST }}..."

          # Create deployment package
          tar -czf deployment.tar.gz -C ./dist .

          # Copy to server
          scp -i ~/.ssh/deploy_key deployment.tar.gz \
            "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/tmp/"

          # Extract on server
          ssh -i ~/.ssh/deploy_key "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" << 'EOF'
            cd ${{ secrets.DEPLOY_PATH }}
            tar -xzf /tmp/deployment.tar.gz
            rm /tmp/deployment.tar.gz
          EOF

          echo "âœ… SSH deployment completed" >> $GITHUB_STEP_SUMMARY

      - name: Deploy Joomla Extension
        if: needs.detect.outputs.project-type == 'joomla' && inputs.deployment-method == 'custom'
        run: |
          echo "### ðŸ”§ Joomla Extension Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Custom Joomla deployment logic
          echo "âš ï¸ Custom Joomla deployment logic required" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Typical steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Upload extension package to Joomla server" >> $GITHUB_STEP_SUMMARY
          echo "2. Install/update via Joomla Extension Manager API" >> $GITHUB_STEP_SUMMARY
          echo "3. Clear Joomla cache" >> $GITHUB_STEP_SUMMARY
          echo "4. Run database migrations if needed" >> $GITHUB_STEP_SUMMARY

          # Placeholder for actual deployment commands
          echo "Add your Joomla-specific deployment commands here"

      - name: Deploy Dolibarr Module
        if: needs.detect.outputs.project-type == 'dolibarr' && inputs.deployment-method == 'custom'
        run: |
          echo "### ðŸ”§ Dolibarr Module Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Custom Dolibarr deployment logic
          echo "âš ï¸ Custom Dolibarr deployment logic required" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Typical steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Upload module to Dolibarr htdocs/custom directory" >> $GITHUB_STEP_SUMMARY
          echo "2. Activate module via Dolibarr API or admin panel" >> $GITHUB_STEP_SUMMARY
          echo "3. Run module setup hooks" >> $GITHUB_STEP_SUMMARY
          echo "4. Clear Dolibarr cache" >> $GITHUB_STEP_SUMMARY

          # Placeholder for actual deployment commands
          echo "Add your Dolibarr-specific deployment commands here"

      - name: Deploy Generic Application
        if: needs.detect.outputs.project-type == 'generic' && inputs.deployment-method == 'custom'
        run: |
          echo "### ðŸ”§ Generic Application Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "âš ï¸ Custom deployment logic required" >> $GITHUB_STEP_SUMMARY
          echo "Add your application-specific deployment commands" >> $GITHUB_STEP_SUMMARY

      - name: Health check
        if: inputs.health-check-url != ''
        run: |
          echo "Running health check on ${{ inputs.health-check-url }}..."

          TIMEOUT=${{ inputs.health-check-timeout }}
          ELAPSED=0
          INTERVAL=10

          while [ $ELAPSED -lt $TIMEOUT ]; do
            if curl -f -s -o /dev/null -w "%{http_code}" "${{ inputs.health-check-url }}" | grep -q "200"; then
              echo "âœ… Health check passed" >> $GITHUB_STEP_SUMMARY
              exit 0
            fi
            echo "Health check attempt $((ELAPSED / INTERVAL + 1)) failed, retrying..."
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done

          echo "âŒ Health check failed after ${TIMEOUT}s" >> $GITHUB_STEP_SUMMARY
          exit 1

      - name: Update deployment status (success)
        if: success()
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          deployment-id: ${{ needs.prepare.outputs.deployment-id }}
          state: success
          environment-url: ${{ inputs.health-check-url }}

      - name: Deployment summary
        if: success()
        run: |
          echo "### âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Project Type:** ${{ needs.detect.outputs.project-type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ inputs.health-check-url }}" ]; then
            echo "**URL:** ${{ inputs.health-check-url }}" >> $GITHUB_STEP_SUMMARY
          fi

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [prepare, deploy]
    if: failure()

    steps:
      - name: Update deployment status (failure)
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          deployment-id: ${{ needs.prepare.outputs.deployment-id }}
          state: failure

      - name: Rollback deployment
        run: |
          echo "### âŒ Deployment Failed - Initiating Rollback" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ Rollback logic needs to be implemented" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Typical rollback steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Restore previous version from backup" >> $GITHUB_STEP_SUMMARY
          echo "2. Revert database migrations if applied" >> $GITHUB_STEP_SUMMARY
          echo "3. Clear caches" >> $GITHUB_STEP_SUMMARY
          echo "4. Verify health checks pass" >> $GITHUB_STEP_SUMMARY

          # Add your rollback commands here
