# Copyright (C) 2026 Moko Consulting <hello@mokoconsulting.tech>
#
# This file is part of a Moko Consulting project.
#
# SPDX-License-Identifier: GPL-3.0-or-later
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <https://www.gnu.org/licenses/>.
#
# FILE INFORMATION
# DEFGROUP: GitHub.Workflow
# INGROUP: MokoStandards.Security
# REPO: https://github.com/mokoconsulting-tech/MokoStandards
# PATH: /.github/workflows/dependency-review.yml
# VERSION: 01.00.00
# BRIEF: Dependency review workflow for vulnerability scanning in pull requests
# NOTE: Scans dependencies for security vulnerabilities and license compliance

name: Dependency Review

on:
  pull_request:
    branches:
      - main
      - dev/**
      - rc/**
      - version/**

permissions:
  contents: read
  pull-requests: write

jobs:
  dependency-review:
    name: Dependency Security Review
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
      
      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          # Fail on critical or high severity vulnerabilities
          fail-on-severity: moderate
          
          # Allow specific licenses (customize for your project)
          # Common open-source licenses
          allow-licenses: GPL-3.0, GPL-3.0-or-later, MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC, LGPL-3.0
          
          # Comment on PR with results
          comment-summary-in-pr: always
      
      - name: Generate Dependency Report
        if: always()
        run: |
          echo "# Dependency Review Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Dependency review completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This workflow checks:" >> $GITHUB_STEP_SUMMARY
          echo "- Security vulnerabilities in new dependencies" >> $GITHUB_STEP_SUMMARY
          echo "- License compatibility" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency changes between base and head" >> $GITHUB_STEP_SUMMARY

  composer-audit:
    name: Composer Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
      
      - name: Check for composer.json
        id: check-composer
        run: |
          if [ -f "composer.json" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Setup PHP
        if: steps.check-composer.outputs.exists == 'true'
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          tools: composer:v2
      
      - name: Install Dependencies
        if: steps.check-composer.outputs.exists == 'true'
        run: composer install --no-interaction --prefer-dist
      
      - name: Run Composer Audit
        if: steps.check-composer.outputs.exists == 'true'
        run: |
          echo "### Composer Audit Results" >> $GITHUB_STEP_SUMMARY
          
          # Run audit and capture results
          if composer audit; then
            echo "✅ No vulnerabilities found in Composer dependencies" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Vulnerabilities detected - please review" >> $GITHUB_STEP_SUMMARY
            composer audit || true
          fi
      
      - name: Check for Outdated Packages
        if: steps.check-composer.outputs.exists == 'true'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Outdated Composer Packages" >> $GITHUB_STEP_SUMMARY
          composer outdated --direct || echo "All packages are up to date" >> $GITHUB_STEP_SUMMARY
      
      - name: Skip Composer Audit
        if: steps.check-composer.outputs.exists == 'false'
        run: |
          echo "### Composer Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "ℹ️ No composer.json found - skipping Composer audit" >> $GITHUB_STEP_SUMMARY

  python-safety:
    name: Python Safety Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
      
      - name: Check for Python dependency files
        id: check-python
        run: |
          if [ -f "requirements.txt" ] || [ -f "pyproject.toml" ] || [ -f "Pipfile" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Setup Python
        if: steps.check-python.outputs.exists == 'true'
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
      
      - name: Install Safety
        if: steps.check-python.outputs.exists == 'true'
        run: pip install safety
      
      - name: Run Safety Check
        if: steps.check-python.outputs.exists == 'true'
        run: |
          echo "### Python Safety Check Results" >> $GITHUB_STEP_SUMMARY
          
          # Check requirements.txt if exists
          if [ -f "requirements.txt" ]; then
            if safety check -r requirements.txt 2>&1 | tee safety_output.txt; then
              echo "✅ No known vulnerabilities in Python dependencies" >> $GITHUB_STEP_SUMMARY
            else
              echo "⚠️ Vulnerabilities detected in Python dependencies" >> $GITHUB_STEP_SUMMARY
              cat safety_output.txt >> $GITHUB_STEP_SUMMARY || true
              rm -f safety_output.txt
              exit 0
            fi
            rm -f safety_output.txt
          else
            echo "ℹ️ No requirements.txt found" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Skip Python Safety Check
        if: steps.check-python.outputs.exists == 'false'
        run: |
          echo "### Python Safety Check Results" >> $GITHUB_STEP_SUMMARY
          echo "ℹ️ No Python dependency files found - skipping Python safety check" >> $GITHUB_STEP_SUMMARY

  license-check:
    name: License Compliance Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
      
      - name: Check License File
        run: |
          echo "### License Compliance" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "LICENSE" ] || [ -f "LICENSE.md" ] || [ -f "LICENSE.txt" ]; then
            echo "✅ LICENSE file present" >> $GITHUB_STEP_SUMMARY
            
            # Check for GPL-3.0 (MokoStandards default)
            if grep -qi "GNU GENERAL PUBLIC LICENSE" LICENSE* 2>/dev/null; then
              echo "✅ GPL-3.0 or compatible license detected" >> $GITHUB_STEP_SUMMARY
            else
              echo "ℹ️ Non-GPL license detected - verify compatibility" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "❌ LICENSE file missing" >> $GITHUB_STEP_SUMMARY
            echo "Please add a LICENSE file to the repository root" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
      
      - name: Check SPDX Headers (Optional)
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### SPDX Header Compliance" >> $GITHUB_STEP_SUMMARY
          
          # Check for SPDX identifiers in source files
          MISSING_HEADERS=0
          
          # Check PHP files
          if find . -name "*.php" -type f ! -path "./vendor/*" | head -1 | grep -q .; then
            TOTAL_PHP=$(find . -name "*.php" -type f ! -path "./vendor/*" | wc -l)
            WITH_SPDX=$(find . -name "*.php" -type f ! -path "./vendor/*" -exec grep -l "SPDX-License-Identifier" {} \; | wc -l)
            echo "- PHP files: $WITH_SPDX/$TOTAL_PHP with SPDX headers" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check JavaScript files
          if find . -name "*.js" -type f ! -path "./node_modules/*" ! -path "./vendor/*" | head -1 | grep -q .; then
            TOTAL_JS=$(find . -name "*.js" -type f ! -path "./node_modules/*" ! -path "./vendor/*" | wc -l)
            WITH_SPDX_JS=$(find . -name "*.js" -type f ! -path "./node_modules/*" ! -path "./vendor/*" -exec grep -l "SPDX-License-Identifier" {} \; | wc -l)
            echo "- JavaScript files: $WITH_SPDX_JS/$TOTAL_JS with SPDX headers" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "ℹ️ SPDX headers are recommended but not required for this check" >> $GITHUB_STEP_SUMMARY

  summary:
    name: Review Summary
    runs-on: ubuntu-latest
    needs: [dependency-review, composer-audit, python-safety, license-check]
    if: always()
    
    steps:
      - name: Generate Final Summary
        run: |
          echo "# Dependency Review Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All dependency security and license checks have been executed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Checks Performed:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ GitHub Dependency Review" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Package Manager Audits (composer, pip)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ License Compliance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review the job results above for any issues that need attention." >> $GITHUB_STEP_SUMMARY
