# Copyright (C) 2026 Moko Consulting <hello@mokoconsulting.tech>
#
# This file is part of a Moko Consulting project.
#
# SPDX-License-Identifier: GPL-3.0-or-later
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <https://www.gnu.org/licenses/>.
#
# FILE INFORMATION
# DEFGROUP: GitHub.Workflow
# INGROUP: MokoStandards.Reusable
# REPO: https://github.com/mokoconsulting-tech/MokoStandards
# PATH: /.github/workflows/reusable-project-detector.yml
# VERSION: 01.00.00
# BRIEF: Reusable workflow for detecting project type (Joomla, Dolibarr, Generic)
# NOTE: Provides project_type and extension_type outputs for downstream workflows

name: Reusable Project Type Detection

on:
  workflow_call:
    inputs:
      working-directory:
        description: 'Working directory for detection'
        required: false
        type: string
        default: '.'
    outputs:
      project-type:
        description: 'Detected project type (joomla, dolibarr, generic)'
        value: ${{ jobs.detect.outputs.project_type }}
      extension-type:
        description: 'Detected extension type (component, module, plugin, etc.)'
        value: ${{ jobs.detect.outputs.extension_type }}
      has-php:
        description: 'Whether project contains PHP files'
        value: ${{ jobs.detect.outputs.has_php }}
      has-node:
        description: 'Whether project contains Node.js/package.json'
        value: ${{ jobs.detect.outputs.has_node }}

permissions:
  contents: read

jobs:
  detect:
    name: Detect Project Type
    runs-on: ubuntu-latest
    outputs:
      project_type: ${{ steps.detect.outputs.project_type }}
      extension_type: ${{ steps.detect.outputs.extension_type }}
      has_php: ${{ steps.detect.outputs.has_php }}
      has_node: ${{ steps.detect.outputs.has_node }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Detect project type and components
        id: detect
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "### ðŸ” Project Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Detection priority: Joomla > Dolibarr > Generic

          # Check for Joomla indicators
          if [ -f "joomla.xml" ] || \
             find . -maxdepth 2 \( -name "mod_*.xml" -o -name "plg_*.xml" -o -name "com_*.xml" -o -name "pkg_*.xml" -o -name "tpl_*.xml" \) 2>/dev/null | head -1 | grep -q .; then
            echo "project_type=joomla" >> $GITHUB_OUTPUT
            echo "**Project Type:** Joomla" >> $GITHUB_STEP_SUMMARY

            # Detect Joomla extension type
            if [ -d "administrator/components" ] || [ -d "components" ]; then
              echo "extension_type=component" >> $GITHUB_OUTPUT
              echo "**Extension Type:** Component" >> $GITHUB_STEP_SUMMARY
            elif find . -maxdepth 1 -name "mod_*.xml" 2>/dev/null | head -1 | grep -q .; then
              echo "extension_type=module" >> $GITHUB_OUTPUT
              echo "**Extension Type:** Module" >> $GITHUB_STEP_SUMMARY
            elif find . -maxdepth 1 -name "plg_*.xml" 2>/dev/null | head -1 | grep -q .; then
              echo "extension_type=plugin" >> $GITHUB_OUTPUT
              echo "**Extension Type:** Plugin" >> $GITHUB_STEP_SUMMARY
            elif find . -maxdepth 1 -name "pkg_*.xml" 2>/dev/null | head -1 | grep -q .; then
              echo "extension_type=package" >> $GITHUB_OUTPUT
              echo "**Extension Type:** Package" >> $GITHUB_STEP_SUMMARY
            elif find . -maxdepth 1 -name "tpl_*.xml" 2>/dev/null | head -1 | grep -q .; then
              echo "extension_type=template" >> $GITHUB_OUTPUT
              echo "**Extension Type:** Template" >> $GITHUB_STEP_SUMMARY
            else
              echo "extension_type=component" >> $GITHUB_OUTPUT
              echo "**Extension Type:** Component (default)" >> $GITHUB_STEP_SUMMARY
            fi

          # Check for Dolibarr indicators
          elif [ -d "htdocs" ] || [ -d "core/modules" ] || \
               ([ -f "composer.json" ] && grep -q "dolibarr" composer.json 2>/dev/null); then
            echo "project_type=dolibarr" >> $GITHUB_OUTPUT
            echo "extension_type=module" >> $GITHUB_OUTPUT
            echo "**Project Type:** Dolibarr" >> $GITHUB_STEP_SUMMARY
            echo "**Extension Type:** Module" >> $GITHUB_STEP_SUMMARY

          # Default to Generic
          else
            echo "project_type=generic" >> $GITHUB_OUTPUT
            echo "extension_type=application" >> $GITHUB_OUTPUT
            echo "**Project Type:** Generic" >> $GITHUB_STEP_SUMMARY
            echo "**Extension Type:** Application" >> $GITHUB_STEP_SUMMARY
          fi

          # Detect PHP presence
          if find . -name "*.php" -type f 2>/dev/null | head -1 | grep -q .; then
            echo "has_php=true" >> $GITHUB_OUTPUT
            echo "- âœ… PHP files detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "has_php=false" >> $GITHUB_OUTPUT
            echo "- â„¹ï¸ No PHP files detected" >> $GITHUB_STEP_SUMMARY
          fi

          # Detect Node.js presence
          if [ -f "package.json" ]; then
            echo "has_node=true" >> $GITHUB_OUTPUT
            echo "- âœ… Node.js project detected (package.json)" >> $GITHUB_STEP_SUMMARY
          else
            echo "has_node=false" >> $GITHUB_OUTPUT
            echo "- â„¹ï¸ No Node.js project detected" >> $GITHUB_STEP_SUMMARY
          fi
