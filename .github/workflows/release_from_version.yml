#
# Copyright (C) 2025 Moko Consulting <hello@mokoconsulting.tech>
#
# This file is part of a Moko Consulting project.
#
# SPDX-License-Identifier: GPL-3.0-or-later
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <https://www.gnu.org/licenses/>.
#
# FILE INFORMATION
# DEFGROUP: GitHub.Workflow
# INGROUP: MokoStandards.Release
# REPO: https://github.com/mokoconsulting-tech/moko-cassiopeia
# PATH: /.github/workflows/release_from_version.yml
# VERSION: 01.00.00
# BRIEF: Enterprise release pipeline for promoting dev branches, building Joomla artifacts, publishing prereleases, and optionally squashing to main.
# NOTE: Designed for Joomla and Dolibarr projects following MokoStandards governance.
#
name: Release from Version Branch Pipeline

on:
  workflow_dispatch:
    inputs:
      promote_to_version:
        description: "Promote dev/<version> to version/<version>"
        required: true
        default: true
        type: boolean
      delete_dev_branch:
        description: "Delete dev/<version> after promotion"
        required: true
        default: true
        type: boolean
      squash_to_main:
    name: 04 Optional squash merge version branch to main (PR-based)
    runs-on: ubuntu-latest
    needs:
      - guard
      - build_update_and_release

    if: ${{ github.event.inputs.squash_to_main == 'true' && startsWith(github.ref_name, 'dev/') }}

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Configure Git identity
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config --global --add safe.directory "${GITHUB_WORKSPACE}"

      - name: Fetch branches
        run: |
          set -euo pipefail
          git fetch origin --prune

      - name: Create squash-merge branch targeting main
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          VERSION="${{ needs.guard.outputs.version }}"
          VBRANCH="origin/${{ needs.guard.outputs.version_branch }}"
          MERGE_BRANCH="merge/${VERSION}"

          # Create a dedicated merge branch off main, squash version branch into it, then open a PR.
          # This is compatible with enterprise branch protections on main.

          git checkout main
          git pull --ff-only origin main

          # Ensure merge branch is fresh
          if git show-ref --verify --quiet "refs/heads/${MERGE_BRANCH}"; then
            git branch -D "${MERGE_BRANCH}"
          fi

          git checkout -b "${MERGE_BRANCH}" main
          git merge --squash "${VBRANCH}"

          if git diff --cached --quiet; then
            echo "No changes to merge from ${VBRANCH}."
            exit 0
          fi

          git commit -m "chore(release): squash ${VERSION} into main"
          git push -u origin "${MERGE_BRANCH}"

          # Create PR (idempotent): if it already exists, do not fail.
          gh pr create \
            --base main \
            --head "${MERGE_BRANCH}" \
            --title "Release ${VERSION} (squash)" \
            --body "Squash merge of version/${VERSION} into main. Generated by release pipeline." \
            || echo "PR may already exist for ${MERGE_BRANCH}."

      - name: Optional delete version branch after PR creation
        run: |
          set -euo pipefail
          if [ "${{ github.event.inputs.delete_version_branch }}" = "true" ]; then
            git push origin --delete "${{ needs.guard.outputs.version_branch }}" || true
          else
            echo "Version branch retention enabled. Skipping deletion."
          fi
