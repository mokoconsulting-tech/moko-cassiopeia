#
# Copyright (C) 2025 Moko Consulting <hello@mokoconsulting.tech>
#
# This file is part of a Moko Consulting project.
#
# SPDX-License-Identifier: GPL-3.0-or-later
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <https://www.gnu.org/licenses/>.
#
# FILE INFORMATION
# DEFGROUP: GitHub.Workflow
# INGROUP: MokoStandards.Release
# REPO: https://github.com/mokoconsulting-tech/moko-cassiopeia
# PATH: /.github/workflows/release_from_version.yml
# VERSION: 01.00.00
# BRIEF: Enterprise release pipeline for promoting dev branches, building Joomla artifacts, publishing prereleases, and optionally squashing to main.
# NOTE: Designed for Joomla and Dolibarr projects following MokoStandards governance.
#
name: Release from Version Branch Pipeline

on:
  workflow_dispatch:
    inputs:
      promote_to_version:
        description: "Promote dev/<version> to version/<version>"
        required: true
        default: true
        type: boolean
      delete_dev_branch:
        description: "Delete dev/<version> after promotion"
        required: true
        default: true
        type: boolean
      squash_to_main:
        description: "Squash merge version/<version> into main"
        required: true
        default: false
        type: boolean
      delete_version_branch:
        description: "Delete version/<version> after squash merge to main"
        required: true
        default: false
        type: boolean

concurrency:
  group: release-from-dev-${{ github.ref_name }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  guard:
    name: 00 Guard and derive release metadata
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.extract.outputs.version }}
      dev_branch: ${{ steps.extract.outputs.dev_branch }}
      version_branch: ${{ steps.extract.outputs.version_branch }}
      today_utc: ${{ steps.extract.outputs.today_utc }}

    steps:
      - name: Validate calling branch and extract version
        id: extract
        run: |
          set -euo pipefail

          BRANCH="${GITHUB_REF_NAME}"
          echo "Invoked from branch: ${BRANCH}"

          # Enterprise gate: only allow manual runs from dev/<major>.<minor>.<patch>
          echo "${BRANCH}" | grep -E '^dev/[0-9]+\.[0-9]+\.[0-9]+$'

          VERSION="${BRANCH#dev/}"
          DEV_BRANCH="dev/${VERSION}"
          VERSION_BRANCH="version/${VERSION}"
          TODAY_UTC="$(date -u +%Y-%m-%d)"

          echo "version=${VERSION}" >> "${GITHUB_OUTPUT}"
          echo "dev_branch=${DEV_BRANCH}" >> "${GITHUB_OUTPUT}"
          echo "version_branch=${VERSION_BRANCH}" >> "${GITHUB_OUTPUT}"
          echo "today_utc=${TODAY_UTC}" >> "${GITHUB_OUTPUT}"

  promote_branch:
    name: 01 Promote dev to version branch
    runs-on: ubuntu-latest
    needs: guard

    if: ${{ github.event.inputs.promote_to_version == 'true' && startsWith(github.ref_name, 'dev/') }}

    permissions:
      contents: write

    steps:
      - name: Checkout dev branch
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.guard.outputs.dev_branch }}
          fetch-depth: 0

      - name: Configure Git identity
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config --global --add safe.directory "${GITHUB_WORKSPACE}"

      - name: Enforce branch promotion preconditions
        run: |
          set -euo pipefail

          SRC="${{ needs.guard.outputs.dev_branch }}"
          DST="${{ needs.guard.outputs.version_branch }}"

          git fetch origin --prune

          if ! git show-ref --verify --quiet "refs/remotes/origin/${SRC}"; then
            echo "ERROR: origin/${SRC} not found."
            exit 1
          fi

          if git show-ref --verify --quiet "refs/remotes/origin/${DST}"; then
            echo "ERROR: origin/${DST} already exists."
            exit 1
          fi

      - name: Promote dev branch to version branch
        run: |
          set -euo pipefail

          SRC="${{ needs.guard.outputs.dev_branch }}"
          DST="${{ needs.guard.outputs.version_branch }}"

          git checkout -B "${DST}" "origin/${SRC}"
          git push origin "${DST}"

          if [ "${{ github.event.inputs.delete_dev_branch }}" = "true" ]; then
            git push origin --delete "${SRC}"
          else
            echo "Dev branch retention enabled. Skipping deletion of ${SRC}."
          fi

          echo "Promotion complete: ${SRC} -> ${DST}"

  normalize_dates:
    name: 02 Normalize dates on version branch
    runs-on: ubuntu-latest
    needs:
      - guard
      - promote_branch

    # If promotion is disabled, run normalization directly on dev branch.
    if: ${{ always() }}

    permissions:
      contents: write

    steps:
      - name: Checkout release working branch
        uses: actions/checkout@v4
        with:
          ref: ${{ (github.event.inputs.promote_to_version == 'true' && startsWith(github.ref_name, 'dev/')) && needs.guard.outputs.version_branch || needs.guard.outputs.dev_branch }}
          fetch-depth: 0

      - name: Configure Git identity
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config --global --add safe.directory "${GITHUB_WORKSPACE}"

      - name: Validate repository release prerequisites
        run: |
          set -euo pipefail
          test -d src || (echo "ERROR: src directory missing." && exit 1)
          test -f CHANGELOG.md || (echo "ERROR: CHANGELOG.md missing." && exit 1)

          VERSION="${{ needs.guard.outputs.version }}"
          if ! grep -qE "^## \\[$VERSION\\] " CHANGELOG.md; then
            echo "ERROR: CHANGELOG.md does not contain a heading for version [$VERSION]."
            exit 1
          fi

      - name: Update dates using repo script when available, otherwise apply baseline updates
        run: |
          set -euo pipefail

          TODAY="${{ needs.guard.outputs.today_utc }}"
          VERSION="${{ needs.guard.outputs.version }}"

          echo "Release version: ${VERSION}"
          echo "Release date (UTC): ${TODAY}"

          if [ -f scripts/update_dates.sh ]; then
            chmod +x scripts/update_dates.sh
            scripts/update_dates.sh "${TODAY}" "${VERSION}"
          else
            echo "scripts/update_dates.sh not found. Applying baseline date normalization."

            find . -type f -name "*.xml" \
              -not -path "./.git/*" \
              -print0 | while IFS= read -r -d '' f; do
                sed -i "s#<creationDate>[^<]*</creationDate>#<creationDate>${TODAY}</creationDate>#g" "${f}" || true
                sed -i "s#<date>[^<]*</date>#<date>${TODAY}</date>#g" "${f}" || true
                sed -i "s#<buildDate>[^<]*</buildDate>#<buildDate>${TODAY}</buildDate>#g" "${f}" || true
              done

            sed -i -E "s#^(## \\[${VERSION}\\]) [0-9]{4}-[0-9]{2}-[0-9]{2}#\ ${TODAY}#g" CHANGELOG.md || true
          fi

      - name: Commit and push date updates
        run: |
          set -euo pipefail

          if git diff --quiet; then
            echo "No date changes detected. No commit required."
            exit 0
          fi

          git add -A
          git commit -m "chore(release): normalize dates for ${{ needs.guard.outputs.version }}"

          TARGET="${{ (github.event.inputs.promote_to_version == 'true' && startsWith(github.ref_name, 'dev/')) && needs.guard.outputs.version_branch || needs.guard.outputs.dev_branch }}"
          git push origin "HEAD:${TARGET}"

  build_update_and_release:
    name: 03 Build Joomla ZIP, update updates.xml, prerelease
    runs-on: ubuntu-latest
    needs:
      - guard
      - normalize_dates

    permissions:
      contents: write
      id-token: write

    environment:
      name: release

    steps:
      - name: Checkout release working branch
        uses: actions/checkout@v4
        with:
          ref: ${{ (github.event.inputs.promote_to_version == 'true' && startsWith(github.ref_name, 'dev/')) && needs.guard.outputs.version_branch || needs.guard.outputs.dev_branch }}
          fetch-depth: 0

      - name: Configure Git identity
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config --global --add safe.directory "${GITHUB
