name: Release from Version Branch Pipeline

on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: "Source dev branch. Example dev/03.06.00"
        required: true

permissions:
  contents: write

jobs:
  rename_branch:
    name: 01 Promote dev to version
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.extract.outputs.version }}
      version_branch: ${{ steps.extract.outputs.version_branch }}

    steps:
      - name: Extract Version from Branch Name
        id: extract
        run: |
          set -euo pipefail

          SRC="${{ inputs.source_branch }}"

          echo "$SRC" | grep -E '^dev/[0-9]+\.[0-9]+\.[0-9]+$'

          VERSION="${SRC#dev/}"
          VERSION_BRANCH="version/$VERSION"

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "version_branch=$VERSION_BRANCH" >> "$GITHUB_OUTPUT"

      - name: Checkout Source Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.source_branch }}
          fetch-depth: 0

      - name: Configure Git Identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Promote dev branch to version branch
        run: |
          set -euo pipefail

          SRC="${{ inputs.source_branch }}"
          DST="${{ steps.extract.outputs.version_branch }}"

          git fetch origin

          if git show-ref --verify --quiet "refs/remotes/origin/$DST"; then
            echo "ERROR: $DST already exists."
            exit 1
          fi

          git checkout -B "$DST" "origin/$SRC"
          git push origin "$DST"
          git push origin --delete "$SRC"
