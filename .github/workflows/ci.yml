# Copyright (C) 2026 Moko Consulting <hello@mokoconsulting.tech>
#
# This file is part of a Moko Consulting project.
#
# SPDX-License-Identifier: GPL-3.0-or-later
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <https://www.gnu.org/licenses/>.
#
# FILE INFORMATION
# DEFGROUP: GitHub.Workflow
# INGROUP: MokoStandards.CI
# REPO: https://github.com/mokoconsulting-tech/MokoStandards
# PATH: /templates/workflows/unified-ci.yml.template
# VERSION: 02.00.00
# BRIEF: Unified Continuous Integration for all platforms (Joomla, Dolibarr, Generic)
# NOTE: Auto-detects platform and languages, runs appropriate validation

name: Unified CI

on:
  push:
    branches:
      - main
      - dev/**
      - rc/**
      - version/**
  pull_request:
    branches:
      - main
      - dev/**
      - rc/**
      - version/**
  workflow_dispatch:

permissions:
  contents: read

jobs:
  detect:
    name: Detect Platform & Languages
    runs-on: ubuntu-latest
    outputs:
      platform: ${{ steps.platform.outputs.type }}
      has_nodejs: ${{ steps.languages.outputs.has_nodejs }}
      has_python: ${{ steps.languages.outputs.has_python }}
      has_php: ${{ steps.languages.outputs.has_php }}
      has_go: ${{ steps.languages.outputs.has_go }}
      has_ruby: ${{ steps.languages.outputs.has_ruby }}
      has_rust: ${{ steps.languages.outputs.has_rust }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Detect platform type
        id: platform
        run: |
          # Detect Joomla
          if [ -f "joomla.xml" ] || find . -maxdepth 2 \( -name "mod_*.xml" -o -name "plg_*.xml" -o -name "com_*.xml" -o -name "pkg_*.xml" -o -name "tpl_*.xml" \) 2>/dev/null | head -1 | grep -q .; then
            echo "type=joomla" >> $GITHUB_OUTPUT
            echo "✓ Detected: Joomla extension" >> $GITHUB_STEP_SUMMARY
          # Detect Dolibarr
          elif [ -d "htdocs" ] || [ -d "core/modules" ] || ([ -f "composer.json" ] && grep -q "dolibarr" composer.json 2>/dev/null); then
            echo "type=dolibarr" >> $GITHUB_OUTPUT
            echo "✓ Detected: Dolibarr module" >> $GITHUB_STEP_SUMMARY
          else
            echo "type=generic" >> $GITHUB_OUTPUT
            echo "✓ Detected: Generic project" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Detect languages
        id: languages
        run: |
          # Node.js
          if [ -f "package.json" ]; then
            echo "has_nodejs=true" >> $GITHUB_OUTPUT
            echo "- Node.js: ✓" >> $GITHUB_STEP_SUMMARY
          else
            echo "has_nodejs=false" >> $GITHUB_OUTPUT
          fi
          
          # Python
          if [ -f "requirements.txt" ] || [ -f "pyproject.toml" ] || [ -f "setup.py" ]; then
            echo "has_python=true" >> $GITHUB_OUTPUT
            echo "- Python: ✓" >> $GITHUB_STEP_SUMMARY
          else
            echo "has_python=false" >> $GITHUB_OUTPUT
          fi
          
          # PHP
          if [ -f "composer.json" ] || find . -maxdepth 2 -name "*.php" 2>/dev/null | head -1 | grep -q .; then
            echo "has_php=true" >> $GITHUB_OUTPUT
            echo "- PHP: ✓" >> $GITHUB_STEP_SUMMARY
          else
            echo "has_php=false" >> $GITHUB_OUTPUT
          fi
          
          # Go
          if [ -f "go.mod" ]; then
            echo "has_go=true" >> $GITHUB_OUTPUT
            echo "- Go: ✓" >> $GITHUB_STEP_SUMMARY
          else
            echo "has_go=false" >> $GITHUB_OUTPUT
          fi
          
          # Ruby
          if [ -f "Gemfile" ]; then
            echo "has_ruby=true" >> $GITHUB_OUTPUT
            echo "- Ruby: ✓" >> $GITHUB_STEP_SUMMARY
          else
            echo "has_ruby=false" >> $GITHUB_OUTPUT
          fi
          
          # Rust
          if [ -f "Cargo.toml" ]; then
            echo "has_rust=true" >> $GITHUB_OUTPUT
            echo "- Rust: ✓" >> $GITHUB_STEP_SUMMARY
          else
            echo "has_rust=false" >> $GITHUB_OUTPUT
          fi

  joomla-validation:
    name: Joomla Validation
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.platform == 'joomla'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml
      
      - name: Validate XML manifests
        run: |
          echo "Validating Joomla manifests..."
          for manifest in $(find . -maxdepth 2 -name "*.xml" -not -path "*/vendor/*" -not -name "phpunit.xml*" -not -name "phpcs.xml*"); do
            echo "Checking $manifest"
            xmllint --noout "$manifest" || exit 1
          done
          echo "✓ All manifests valid" >> $GITHUB_STEP_SUMMARY
      
      - name: Validate PHP syntax
        run: |
          echo "Checking PHP syntax..."
          find . -name "*.php" -not -path "*/vendor/*" -exec php -l {} \; | grep -v "No syntax errors"
          echo "✓ PHP syntax valid" >> $GITHUB_STEP_SUMMARY
      
      - name: Check Joomla standards
        run: |
          if [ -f "scripts/validate/manifest.sh" ]; then
            bash scripts/validate/manifest.sh
          fi

  dolibarr-validation:
    name: Dolibarr Validation
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.platform == 'dolibarr'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, mysqli
      
      - name: Validate module structure
        run: |
          echo "Validating Dolibarr module structure..."
          
          if [ ! -d "core" ] && [ ! -d "htdocs" ]; then
            echo "⚠️ Warning: Neither 'core' nor 'htdocs' directory found" >> $GITHUB_STEP_SUMMARY
          else
            echo "✓ Module structure valid" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Validate PHP syntax
        run: |
          echo "Checking PHP syntax..."
          find . -name "*.php" -not -path "*/vendor/*" -exec php -l {} \; | grep -v "No syntax errors"
          echo "✓ PHP syntax valid" >> $GITHUB_STEP_SUMMARY
      
      - name: Check Dolibarr compatibility
        run: |
          if [ -f "scripts/validate/dolibarr_validate.sh" ]; then
            bash scripts/validate/dolibarr_validate.sh
          fi

  nodejs-ci:
    name: Node.js CI
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.has_nodejs == 'true'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run linter
        run: npm run lint
        if: hashFiles('package.json') != '' && contains(fromJSON('["lint"]'), 'lint')
        continue-on-error: true
      
      - name: Run tests
        run: npm test
        if: hashFiles('package.json') != '' && contains(fromJSON('["test"]'), 'test')

  python-ci:
    name: Python CI
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.has_python == 'true'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          fi
          if [ -f "pyproject.toml" ]; then
            pip install .
          fi
      
      - name: Run linter
        run: |
          if [ -f ".pylintrc" ]; then
            pip install pylint
            pylint **/*.py || true
          fi
      
      - name: Run tests
        run: |
          if [ -f "pytest.ini" ] || [ -d "tests" ]; then
            pip install pytest
            pytest
          fi

  php-ci:
    name: PHP CI
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.has_php == 'true'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml
          tools: composer:v2
      
      - name: Validate composer.json
        run: composer validate --strict
        if: hashFiles('composer.json') != ''
      
      - name: Install dependencies
        run: composer install --prefer-dist --no-progress
        if: hashFiles('composer.json') != ''
      
      - name: PHP Syntax Check
        run: |
          find . -name "*.php" -not -path "*/vendor/*" -exec php -l {} \;

  go-ci:
    name: Go CI
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.has_go == 'true'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true
      
      - name: Build
        run: go build -v ./...
      
      - name: Test
        run: go test -v ./...

  ruby-ci:
    name: Ruby CI
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.has_ruby == 'true'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
      
      - name: Install dependencies
        run: bundle install
      
      - name: Run tests
        run: bundle exec rake test

  rust-ci:
    name: Rust CI
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.has_rust == 'true'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      
      - name: Build
        run: cargo build --verbose
      
      - name: Test
        run: cargo test --verbose

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [detect, joomla-validation, dolibarr-validation, nodejs-ci, python-ci, php-ci, go-ci, ruby-ci, rust-ci]
    if: always()
    
    steps:
      - name: Generate CI summary
        run: |
          echo "# Unified CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Platform**: ${{ needs.detect.outputs.platform }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Validation Results" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.detect.outputs.platform }}" = "joomla" ]; then
            echo "- Joomla Validation: ${{ needs.joomla-validation.result }}" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.detect.outputs.platform }}" = "dolibarr" ]; then
            echo "- Dolibarr Validation: ${{ needs.dolibarr-validation.result }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.detect.outputs.has_nodejs }}" = "true" ]; then
            echo "- Node.js CI: ${{ needs.nodejs-ci.result }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.detect.outputs.has_python }}" = "true" ]; then
            echo "- Python CI: ${{ needs.python-ci.result }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.detect.outputs.has_php }}" = "true" ]; then
            echo "- PHP CI: ${{ needs.php-ci.result }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.detect.outputs.has_go }}" = "true" ]; then
            echo "- Go CI: ${{ needs.go-ci.result }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.detect.outputs.has_ruby }}" = "true" ]; then
            echo "- Ruby CI: ${{ needs.ruby-ci.result }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.detect.outputs.has_rust }}" = "true" ]; then
            echo "- Rust CI: ${{ needs.rust-ci.result }}" >> $GITHUB_STEP_SUMMARY
          fi
