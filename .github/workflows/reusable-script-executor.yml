# Copyright (C) 2026 Moko Consulting <hello@mokoconsulting.tech>
# SPDX-License-Identifier: GPL-3.0-or-later
# FILE INFORMATION
# DEFGROUP: GitHub.Workflows
# INGROUP: MokoStandards.Reusable
# REPO: https://github.com/mokoconsulting-tech/MokoStandards
# PATH: /.github/workflows/reusable-script-executor.yml
# VERSION: 01.00.00
# BRIEF: Reusable workflow to execute MokoStandards scripts in any repository
# NOTE: Provides unified script execution with proper environment setup

name: Execute MokoStandards Script

on:
  workflow_call:
    inputs:
      script_path:
        description: 'Path to script relative to scripts/ directory (e.g., validate/no_secrets.py)'
        required: true
        type: string
      script_args:
        description: 'Arguments to pass to the script'
        required: false
        type: string
        default: ''
      python_version:
        description: 'Python version to use'
        required: false
        type: string
        default: '3.11'
      install_dependencies:
        description: 'Install Python dependencies (pyyaml, etc.)'
        required: false
        type: boolean
        default: true
      working_directory:
        description: 'Working directory for script execution'
        required: false
        type: string
        default: '.'
      create_summary:
        description: 'Create GitHub step summary'
        required: false
        type: boolean
        default: true
    outputs:
      exit_code:
        description: 'Script exit code'
        value: ${{ jobs.execute-script.outputs.exit_code }}
      script_output:
        description: 'Script output (truncated to 1000 chars)'
        value: ${{ jobs.execute-script.outputs.script_output }}

jobs:
  execute-script:
    name: Execute ${{ inputs.script_path }}
    runs-on: ubuntu-latest

    outputs:
      exit_code: ${{ steps.run-script.outputs.exit_code }}
      script_output: ${{ steps.run-script.outputs.script_output }}

    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Python
        if: endsWith(inputs.script_path, '.py')
        uses: actions/setup-python@v6
        with:
          python-version: ${{ inputs.python_version }}

      - name: Install Python dependencies
        if: endsWith(inputs.script_path, '.py') && inputs.install_dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

          # Install additional dependencies if requirements file exists
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          fi

          if [ "${{ inputs.create_summary }}" == "true" ]; then
            echo "## ðŸ“¦ Dependencies Installed" >> $GITHUB_STEP_SUMMARY
            echo "- Python ${{ inputs.python_version }}" >> $GITHUB_STEP_SUMMARY
            echo "- PyYAML (for configuration)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Setup Bash
        if: endsWith(inputs.script_path, '.sh')
        run: |
          bash --version

      - name: Verify script exists
        id: verify
        run: |
          SCRIPT_PATH="scripts/${{ inputs.script_path }}"

          if [ ! -f "$SCRIPT_PATH" ]; then
            echo "âŒ Script not found: $SCRIPT_PATH" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Available scripts:" >> $GITHUB_STEP_SUMMARY
            find scripts -name "*.py" -o -name "*.sh" | sort >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "script_full_path=$SCRIPT_PATH" >> $GITHUB_OUTPUT

          if [ "${{ inputs.create_summary }}" == "true" ]; then
            echo "## âœ… Script Found" >> $GITHUB_STEP_SUMMARY
            echo "**Path:** \`$SCRIPT_PATH\`" >> $GITHUB_STEP_SUMMARY
            echo "**Type:** $(file -b $SCRIPT_PATH)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Make script executable
        run: |
          chmod +x ${{ steps.verify.outputs.script_full_path }}

      - name: Run script
        id: run-script
        working-directory: ${{ inputs.working_directory }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SCRIPT_PATH="${{ steps.verify.outputs.script_full_path }}"
          SCRIPT_ARGS="${{ inputs.script_args }}"

          echo "## ðŸš€ Executing Script" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Script:** \`$SCRIPT_PATH\`" >> $GITHUB_STEP_SUMMARY
          echo "**Arguments:** \`$SCRIPT_ARGS\`" >> $GITHUB_STEP_SUMMARY
          echo "**Working Directory:** \`${{ inputs.working_directory }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Output" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

          # Execute script and capture output
          set +e

          if [[ "$SCRIPT_PATH" == *.py ]]; then
            OUTPUT=$(python3 "$SCRIPT_PATH" $SCRIPT_ARGS 2>&1)
            EXIT_CODE=$?
          elif [[ "$SCRIPT_PATH" == *.sh ]]; then
            OUTPUT=$(bash "$SCRIPT_PATH" $SCRIPT_ARGS 2>&1)
            EXIT_CODE=$?
          else
            OUTPUT=$("$SCRIPT_PATH" $SCRIPT_ARGS 2>&1)
            EXIT_CODE=$?
          fi

          set -e

          # Save outputs
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

          # Truncate output for GitHub output (max 1000 chars)
          OUTPUT_TRUNCATED="${OUTPUT:0:1000}"
          echo "script_output<<EOF" >> $GITHUB_OUTPUT
          echo "$OUTPUT_TRUNCATED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Show full output in summary (with line limit)
          echo "$OUTPUT" | head -n 100 >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Report exit code
          if [ $EXIT_CODE -eq 0 ]; then
            echo "### âœ… Script Completed Successfully" >> $GITHUB_STEP_SUMMARY
            echo "**Exit Code:** $EXIT_CODE" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Script Failed" >> $GITHUB_STEP_SUMMARY
            echo "**Exit Code:** $EXIT_CODE" >> $GITHUB_STEP_SUMMARY
          fi

          exit $EXIT_CODE

      - name: Upload script output
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: script-output-${{ github.run_id }}
          path: |
            *.log
            *.json
            *.csv
          retention-days: 7
          if-no-files-found: ignore
